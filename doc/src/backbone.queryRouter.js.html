<!DOCTYPE html>
<html>
<head>
  <title>backbone.queryRouter.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "src/backbone.queryRouter.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>backbone.queryRouter.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-1" id="line-1">1</a>  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
<a class="line-num" href="#line-2" id="line-2">2</a>  
<a class="line-num" href="#line-3" id="line-3">3</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Is there a better way to pick up window globals?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-3" id="line-3">3</a>  
<a class="line-num" href="#line-4" id="line-4">4</a>  <span class="kd">var</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">)</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">);</span>
<a class="line-num" href="#line-5" id="line-5">5</a>  <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">_</span><span class="p">)</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<a class="line-num" href="#line-6" id="line-6">6</a>  <span class="kd">var</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">);</span>
<a class="line-num" href="#line-7" id="line-7">7</a>  <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;deep-diff&#39;</span><span class="p">);</span>
<a class="line-num" href="#line-8" id="line-8">8</a>  
<a class="line-num" href="#line-9" id="line-9">9</a>  
<a class="line-num" href="#line-10" id="line-10">10</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Backbone.History overrides.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Type</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Backbone.History
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-12" id="line-12">12</a>  
<a class="line-num" href="#line-13" id="line-13">13</a>  <span class="kd">var</span> <span class="nx">QueryHistory</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="cm">/** @lends QueryHistory# **/</span><span class="p">{</span>
<a class="line-num" href="#line-14" id="line-14">14</a>  
<a class="line-num" href="#line-15" id="line-15">15</a>  
<a class="line-num" href="#line-16" id="line-16">16</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Extracts querystrings from routes.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Type</div>
    <div class="dox_tag_detail">
      <span class="dox_type">RegExp
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-18" id="line-18">18</a>  
<a class="line-num" href="#line-19" id="line-19">19</a>    <span class="nx">queryMatcher</span><span class="o">:</span> <span class="sr">/^([^?]*?)(?:\?([\s\S]*))?$/</span><span class="p">,</span>
<a class="line-num" href="#line-20" id="line-20">20</a>    <span class="nx">query</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">(),</span>
<a class="line-num" href="#line-21" id="line-21">21</a>  
<a class="line-num" href="#line-22" id="line-22">22</a>  
<a class="line-num" href="#line-23" id="line-23">23</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Parse a fragment into a query object and call handlers matching.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fragment</span>
      <span class="dox_type">String</span>
      <span>Route fragment.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">Object</span>
      <span>Navigation options.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-26" id="line-26">26</a>  
<a class="line-num" href="#line-27" id="line-27">27</a>    <span class="nx">loadQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-28" id="line-28">28</a>  
<a class="line-num" href="#line-29" id="line-29">29</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>init</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-28" id="line-28">28</a>  
<a class="line-num" href="#line-29" id="line-29">29</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">previousQuery</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">previousQuery</span> <span class="o">=</span> <span class="p">{};</span>
<a class="line-num" href="#line-30" id="line-30">30</a>  
<a class="line-num" href="#line-31" id="line-31">31</a>      <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fragmentToQueryObject</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
<a class="line-num" href="#line-32" id="line-32">32</a>      <span class="kd">var</span> <span class="nx">previous</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">previousQuery</span><span class="p">;</span>
<a class="line-num" href="#line-33" id="line-33">33</a>  
<a class="line-num" href="#line-34" id="line-34">34</a>  
<a class="line-num" href="#line-35" id="line-35">35</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Save previous query.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-34" id="line-34">34</a>  
<a class="line-num" href="#line-35" id="line-35">35</a>      <span class="k">this</span><span class="p">.</span><span class="nx">previousQuery</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>
<a class="line-num" href="#line-36" id="line-36">36</a>  
<a class="line-num" href="#line-37" id="line-37">37</a>  
<a class="line-num" href="#line-38" id="line-38">38</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Diff new and old queries.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-37" id="line-37">37</a>  
<a class="line-num" href="#line-38" id="line-38">38</a>      <span class="kd">var</span> <span class="nx">diffs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getDiffs</span><span class="p">(</span><span class="nx">previous</span><span class="p">,</span> <span class="nx">query</span><span class="p">);</span>
<a class="line-num" href="#line-39" id="line-39">39</a>  
<a class="line-num" href="#line-40" id="line-40">40</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">diffs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a class="line-num" href="#line-41" id="line-41">41</a>  
<a class="line-num" href="#line-42" id="line-42">42</a>  
<a class="line-num" href="#line-43" id="line-43">43</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Call each function that subscribes to these items.
This is intentional, rather than fire events on each changed item;
this way, you don't have to debounce your handlers since they are only called once,
even if multiple query items change.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-45" id="line-45">45</a>  
<a class="line-num" href="#line-46" id="line-46">46</a>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">queryHandlers</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-47" id="line-47">47</a>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">diffs</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">bindings</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-48" id="line-48">48</a>          <span class="nx">handler</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
<a class="line-num" href="#line-49" id="line-49">49</a>        <span class="p">}</span>
<a class="line-num" href="#line-50" id="line-50">50</a>      <span class="p">});</span>
<a class="line-num" href="#line-51" id="line-51">51</a>    <span class="p">},</span>
<a class="line-num" href="#line-52" id="line-52">52</a>  
<a class="line-num" href="#line-53" id="line-53">53</a>  
<a class="line-num" href="#line-54" id="line-54">54</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Override loadUrl &amp; watch return value. Trigger event if no route was matched.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Boolean</span>
      <span>True if a route was matched.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-56" id="line-56">56</a>  
<a class="line-num" href="#line-57" id="line-57">57</a>    <span class="nx">loadUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a class="line-num" href="#line-58" id="line-58">58</a>      <span class="kd">var</span> <span class="nx">matched</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadUrl</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<a class="line-num" href="#line-59" id="line-59">59</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matched</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-60" id="line-60">60</a>        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;routeNotFound&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<a class="line-num" href="#line-61" id="line-61">61</a>      <span class="p">}</span>
<a class="line-num" href="#line-62" id="line-62">62</a>      <span class="k">return</span> <span class="nx">matched</span><span class="p">;</span>
<a class="line-num" href="#line-63" id="line-63">63</a>    <span class="p">},</span>
<a class="line-num" href="#line-64" id="line-64">64</a>  
<a class="line-num" href="#line-65" id="line-65">65</a>  
<a class="line-num" href="#line-66" id="line-66">66</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Add loadQuery hook.
Add 'forceTrigger' option that will trigger a route regardless of whether 
or not we're already at that route.
Also trigger '[before, after]Navigate' event.</p>
  </div>
  <div class="body"><p>Backbone.History is the prototype name, Backbone.history is the actual object, 
but Backbone.History stores the 'started' flag. Whatever.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-73" id="line-73">73</a>  
<a class="line-num" href="#line-74" id="line-74">74</a>    <span class="nx">navigate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-75" id="line-75">75</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
<a class="line-num" href="#line-76" id="line-76">76</a>  
<a class="line-num" href="#line-77" id="line-77">77</a>  
<a class="line-num" href="#line-78" id="line-78">78</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Throw a navigate route so we can hook to this elsewhere in the app.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-77" id="line-77">77</a>  
<a class="line-num" href="#line-78" id="line-78">78</a>      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;beforeNavigate&#39;</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<a class="line-num" href="#line-79" id="line-79">79</a>  
<a class="line-num" href="#line-80" id="line-80">80</a>  
<a class="line-num" href="#line-81" id="line-81">81</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Fire querystring routes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-80" id="line-80">80</a>  
<a class="line-num" href="#line-81" id="line-81">81</a>      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">trigger</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-82" id="line-82">82</a>        <span class="k">this</span><span class="p">.</span><span class="nx">loadQuery</span><span class="p">(</span><span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<a class="line-num" href="#line-83" id="line-83">83</a>      <span class="p">}</span>
<a class="line-num" href="#line-84" id="line-84">84</a>  
<a class="line-num" href="#line-85" id="line-85">85</a>  
<a class="line-num" href="#line-86" id="line-86">86</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Support 'forceTrigger' to trigger a route even if the url hasn't changed.
Have to check History.started here if we call loadUrl directly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-86" id="line-86">86</a>  
<a class="line-num" href="#line-87" id="line-87">87</a>      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceTrigger</span> <span class="o">&amp;&amp;</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">fragment</span> <span class="o">===</span> <span class="nx">fragment</span> <span class="o">&amp;&amp;</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">started</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-88" id="line-88">88</a>        <span class="k">this</span><span class="p">.</span><span class="nx">loadUrl</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
<a class="line-num" href="#line-89" id="line-89">89</a>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a class="line-num" href="#line-90" id="line-90">90</a>  
<a class="line-num" href="#line-91" id="line-91">91</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Call navigate on prototype since we just overrode it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-90" id="line-90">90</a>  
<a class="line-num" href="#line-91" id="line-91">91</a>        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">navigate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<a class="line-num" href="#line-92" id="line-92">92</a>      <span class="p">}</span>
<a class="line-num" href="#line-93" id="line-93">93</a>      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;afterNavigate&#39;</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<a class="line-num" href="#line-94" id="line-94">94</a>    <span class="p">},</span>
<a class="line-num" href="#line-95" id="line-95">95</a>  
<a class="line-num" href="#line-96" id="line-96">96</a>  
<a class="line-num" href="#line-97" id="line-97">97</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Add a query to be tested when the fragment changes.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Array}   bindings  Query keys to listen to.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Function} callback Callback to call when these keys change.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-100" id="line-100">100</a>  
<a class="line-num" href="#line-101" id="line-101">101</a>    <span class="nx">queryHandler</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bindings</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-102" id="line-102">102</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">queryHandlers</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">queryHandlers</span> <span class="o">=</span> <span class="p">[];</span>
<a class="line-num" href="#line-103" id="line-103">103</a>      <span class="k">this</span><span class="p">.</span><span class="nx">queryHandlers</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">bindings</span><span class="o">:</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span><span class="p">});</span>
<a class="line-num" href="#line-104" id="line-104">104</a>    <span class="p">},</span>
<a class="line-num" href="#line-105" id="line-105">105</a>  
<a class="line-num" href="#line-106" id="line-106">106</a>  
<a class="line-num" href="#line-107" id="line-107">107</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Given two objects, compute their differences and list them.
When diffing deep objects, return one string for the object and one for each child.
This allows functions to bind to deep properties or its parent.
E.g. a change to a.b.c returns ['a', 'a.b', 'a.b.c']</p>
  </div>
  <div class="body"><p>This uses DeepDiff (flitbit/diff), which can detect changes deep within objects.
We don't use objects in querystrings quite yet, but we do arrays. And that might change.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object} lhs Left hand object.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object} rhs Right hand (new) object.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Array</span>
      <span>Array of string differences.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-122" id="line-122">122</a>  
<a class="line-num" href="#line-123" id="line-123">123</a>    <span class="nx">_getDiffs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-124" id="line-124">124</a>      <span class="kd">var</span> <span class="nx">diffs</span> <span class="o">=</span> <span class="nx">diff</span><span class="p">(</span><span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span><span class="p">);</span>
<a class="line-num" href="#line-125" id="line-125">125</a>      <span class="kd">var</span> <span class="nx">diffKeys</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">diffs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">diff</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-126" id="line-126">126</a>        <span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-127" id="line-127">127</a>          <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<a class="line-num" href="#line-128" id="line-128">128</a>        <span class="p">});</span>
<a class="line-num" href="#line-129" id="line-129">129</a>        <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">paths</span><span class="p">);</span>
<a class="line-num" href="#line-130" id="line-130">130</a>      <span class="p">},</span> <span class="p">[]);</span>
<a class="line-num" href="#line-131" id="line-131">131</a>      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">diffKeys</span><span class="p">);</span>
<a class="line-num" href="#line-132" id="line-132">132</a>    <span class="p">},</span>
<a class="line-num" href="#line-133" id="line-133">133</a>  
<a class="line-num" href="#line-134" id="line-134">134</a>  
<a class="line-num" href="#line-135" id="line-135">135</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Given a fragment, return a query object.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{String} fragment Route fragment.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Object</span>
      <span>Query object.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-138" id="line-138">138</a>  
<a class="line-num" href="#line-139" id="line-139">139</a>    <span class="nx">_fragmentToQueryObject</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fragment</span><span class="p">)</span> <span class="p">{</span>
<a class="line-num" href="#line-140" id="line-140">140</a>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fragment</span><span class="p">)</span> <span class="k">return</span> <span class="p">{};</span>
<a class="line-num" href="#line-141" id="line-141">141</a>      <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">fragment</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">queryMatcher</span><span class="p">);</span>
<a class="line-num" href="#line-142" id="line-142">142</a>      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a class="line-num" href="#line-143" id="line-143">143</a>      <span class="kd">var</span> <span class="nx">qs</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a class="line-num" href="#line-144" id="line-144">144</a>      <span class="k">return</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">qs</span><span class="p">);</span>
<a class="line-num" href="#line-145" id="line-145">145</a>    <span class="p">}</span>
<a class="line-num" href="#line-146" id="line-146">146</a>  <span class="p">});</span>
<a class="line-num" href="#line-147" id="line-147">147</a>  
<a class="line-num" href="#line-148" id="line-148">148</a>  
<a class="line-num" href="#line-149" id="line-149">149</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Backbone.Router overrides.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Type</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Backbone.Router
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-151" id="line-151">151</a>  
<a class="line-num" href="#line-152" id="line-152">152</a>  <span class="kd">var</span> <span class="nx">QueryRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="cm">/** @lends QueryRouter# */</span><span class="p">{</span>
<a class="line-num" href="#line-153" id="line-153">153</a>  
<a class="line-num" href="#line-154" id="line-154">154</a>  <span class="p">});</span>
<a class="line-num" href="#line-155" id="line-155">155</a>  
<a class="line-num" href="#line-156" id="line-156">156</a>  
<a class="line-num" href="#line-157" id="line-157">157</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Override default Backbone.Router constructor.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-156" id="line-156">156</a>  
<a class="line-num" href="#line-157" id="line-157">157</a>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">QueryRouter</span><span class="p">;</span>
<a class="line-num" href="#line-158" id="line-158">158</a>  
<a class="line-num" href="#line-159" id="line-159">159</a>  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Replace Backbone.history.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><a class="line-num" href="#line-158" id="line-158">158</a>  
<a class="line-num" href="#line-159" id="line-159">159</a>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryHistory</span><span class="p">();</span>
<a class="line-num" href="#line-160" id="line-160">160</a>  </pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
